pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'localhost:5000'
        IMAGE_TAG = "${BUILD_NUMBER}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    env.GIT_COMMIT_SHORT = sh(
                        script: "git rev-parse --short HEAD",
                        returnStdout: true
                    ).trim()
                }
            }
        }
        
        stage('Test Backend') {
            steps {
                dir('app/backend') {
                    sh 'npm ci'
                    sh 'npm test'
                }
            }
            post {
                always {
                    publishTestResults testResultsPattern: 'app/backend/test-results.xml'
                }
            }
        }
        
        stage('Test Frontend') {
            steps {
                dir('app/frontend') {
                    sh 'npm ci'
                    sh 'npm run test'
                }
            }
        }
        
        stage('Build Images') {
            parallel {
                stage('Build Backend') {
                    steps {
                        dir('app/backend') {
                            sh "docker build -t rps-backend:${IMAGE_TAG} ."
                            sh "docker tag rps-backend:${IMAGE_TAG} rps-backend:latest"
                        }
                    }
                }
                stage('Build Frontend') {
                    steps {
                        dir('app/frontend') {
                            sh "docker build -t rps-frontend:${IMAGE_TAG} ."
                            sh "docker tag rps-frontend:${IMAGE_TAG} rps-frontend:latest"
                        }
                    }
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                script {
                    sh '''
                        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                            aquasec/trivy:latest image rps-backend:${IMAGE_TAG}
                        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
                            aquasec/trivy:latest image rps-frontend:${IMAGE_TAG}
                    '''
                }
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'main'
            }
            steps {
                sh '''
                    docker-compose -f docker-compose.staging.yml down
                    docker-compose -f docker-compose.staging.yml up -d
                '''
            }
        }
        
        stage('Integration Tests') {
            when {
                branch 'main'
            }
            steps {
                sh '''
                    sleep 30
                    curl -f http://localhost:8000/api/health || exit 1
                    curl -f http://localhost:3000/health || exit 1
                '''
            }
        }
        
        stage('Deploy to Production') {
            when {
                allOf {
                    branch 'main'
                    expression { return params.DEPLOY_TO_PRODUCTION == true }
                }
            }
            steps {
                script {
                    timeout(time: 5, unit: 'MINUTES') {
                        input message: 'Deploy to Production?', ok: 'Deploy'
                    }
                }
                sh '''
                    kubectl set image deployment/rps-backend rps-backend=rps-backend:${IMAGE_TAG}
                    kubectl set image deployment/rps-frontend rps-frontend=rps-frontend:${IMAGE_TAG}
                    kubectl rollout status deployment/rps-backend
                    kubectl rollout status deployment/rps-frontend
                '''
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            echo "✅ Pipeline completed successfully!"
        }
        failure {
            echo "❌ Pipeline failed!"
        }
    }
}

parameters {
    booleanParam(
        name: 'DEPLOY_TO_PRODUCTION',
        defaultValue: false,
        description: 'Deploy to production environment'
    )
}